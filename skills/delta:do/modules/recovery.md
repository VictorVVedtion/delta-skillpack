# 错误恢复模块 (Error Recovery Module)

## 概述

智能错误诊断和恢复系统，支持自动修复常见问题，提供多种恢复策略选项。

---

## 错误分类

### Level 1: 可自动恢复

| 错误类型 | 症状 | 自动恢复策略 |
|----------|------|--------------|
| 网络超时 | API 调用超时 | 等待 5 秒重试，最多 3 次 |
| 临时文件锁 | 文件正在使用 | 等待 2 秒重试，最多 5 次 |
| 语法错误 (简单) | 缺少分号/括号 | 自动检测并修复 |
| 格式错误 | JSON/YAML 格式问题 | 尝试自动格式化 |

### Level 2: 需用户确认

| 错误类型 | 症状 | 需确认内容 |
|----------|------|------------|
| 文件权限 | 无法读写文件 | 是否修改权限 |
| 依赖缺失 | 模块未找到 | 是否安装依赖 |
| 测试失败 | 测试未通过 | 是否继续或修复 |
| 冲突检测 | Git 冲突 | 如何解决冲突 |

### Level 3: 需用户介入

| 错误类型 | 症状 | 必需操作 |
|----------|------|----------|
| 认证失败 | API 密钥无效 | 用户提供凭证 |
| 业务逻辑 | 需求不明确 | 用户澄清需求 |
| 系统级 | 磁盘满/内存不足 | 用户处理系统问题 |

---

## 错误诊断流程

### Step 1: 捕获错误

```
1. 记录错误发生位置（阶段、子任务、步骤）
2. 记录错误消息和堆栈
3. 记录当前环境状态
4. 保存错误前检查点
```

### Step 2: 分析错误

```
1. 解析错误类型
2. 匹配已知错误模式
3. 评估影响范围
4. 确定恢复难度
```

### Step 3: 输出诊断

```
════════════════════════════════════════════════════════════
⚠️ 执行错误
════════════════════════════════════════════════════════════
阶段: Phase {N} - {阶段名称}
位置: {具体位置描述}
────────────────────────────────────────────────────────────
错误类型: {错误分类}
错误代码: {错误码}（如有）
错误消息: {错误信息}
────────────────────────────────────────────────────────────
📊 影响分析:
  已完成: {已完成步骤}
  受影响: {受影响的文件/功能}
  可恢复: {是/否}
────────────────────────────────────────────────────────────
💡 诊断建议:
  {具体的诊断结论和建议}
────────────────────────────────────────────────────────────
```

---

## 恢复选项

### 标准恢复菜单

```
📋 恢复选项:

  [1] 🔄 继续 - 从失败点继续执行
      └── 跳过失败操作，继续下一步

  [2] 🔁 重试 - 重新执行当前步骤
      └── 使用相同参数重试当前操作

  [3] ⏪ 回滚 - 撤销本次所有变更
      └── 恢复到任务开始前的状态

  [4] ⏭️ 跳过 - 跳过当前阶段
      └── 标记当前阶段为跳过，继续下一阶段

  [5] ⛔ 中止 - 终止执行
      └── 保留已完成的工作，停止执行

请选择 (1-5):
```

### 选项详情

#### [1] 继续

- 保存错误日志
- 标记当前步骤为"跳过"
- 从下一步继续执行
- **适用**: 非关键步骤失败

#### [2] 重试

- 清除错误状态
- 重新执行当前步骤
- 最多重试 2 次（自动重试不计入）
- **适用**: 临时性错误

#### [3] 回滚

- 读取检查点备份
- 撤销所有文件变更
- 恢复到任务开始状态
- **适用**: 发现重大问题

#### [4] 跳过

- 标记当前阶段为"跳过"
- 记录跳过原因
- 进入下一阶段
- **适用**: 当前阶段可延后处理

#### [5] 中止

- 保存当前检查点
- 记录中止原因
- 输出完成摘要
- **适用**: 需要用户介入

---

## 自动恢复策略

### 网络错误

```python
retry_config = {
    "max_retries": 3,
    "base_delay": 5,  # 秒
    "backoff": 2,     # 指数退避
    "max_delay": 30
}

# 重试序列: 5s, 10s, 20s
```

### 语法错误自动修复

**支持的修复**:
- 缺少分号 → 自动添加
- 缺少闭合括号 → 自动添加
- 缩进错误 → 自动修正
- 尾随逗号 → 自动处理

**修复流程**:
```
1. 解析错误信息定位问题
2. 应用修复
3. 重新验证
4. 如修复失败，回退并报告
```

### 文件锁等待

```
max_wait: 10 秒
check_interval: 2 秒
retry_count: 5 次
```

---

## 智能诊断建议

### 错误模式匹配

| 错误模式 | 诊断 | 建议 |
|----------|------|------|
| `ENOENT` | 文件不存在 | 检查路径，或创建文件 |
| `EACCES` | 权限不足 | 检查文件权限 |
| `ENOSPC` | 磁盘空间不足 | 清理磁盘空间 |
| `MODULE_NOT_FOUND` | 依赖缺失 | 运行 npm install |
| `SyntaxError` | 语法错误 | 检查代码语法 |
| `TypeError` | 类型错误 | 检查变量类型 |
| `ETIMEDOUT` | 网络超时 | 检查网络连接 |
| `401/403` | 认证/授权失败 | 检查凭证 |

### 上下文感知建议

基于当前执行阶段提供针对性建议：

**Phase 1 (分析/规划)**:
- 建议重新分析任务描述
- 检查项目结构是否正确

**Phase 2 (实现)**:
- 检查依赖是否安装
- 验证 API 接口是否可用

**Phase 3 (审查)**:
- 运行测试确认功能
- 检查代码风格

---

## 错误日志

### 日志格式

位置: `.skillpack/current/error.log`

```
================================================================================
[2024-01-18T10:30:45.123Z] ERROR
================================================================================
Phase: 2 - 实现
Step: 3 - 创建认证模块
File: src/auth.ts

Type: SyntaxError
Message: Unexpected token '}'
Stack:
  at Parser.parse (parser.js:123)
  at compile (compiler.js:45)

Context:
  Line: 42
  Code: if (user.isValid) {

Recovery:
  Attempt: auto-fix
  Result: success
  Action: Added missing closing brace at line 58

================================================================================
```

### 日志级别

| 级别 | 说明 | 记录内容 |
|------|------|----------|
| ERROR | 执行错误 | 完整错误信息 + 上下文 |
| WARN | 警告 | 潜在问题 |
| INFO | 信息 | 恢复操作记录 |
| DEBUG | 调试 | 详细执行步骤（可选） |

---

## 回滚机制

### 文件级回滚

```
1. 读取检查点中的文件校验和
2. 比对当前文件
3. 恢复修改的文件（从 Git 或备份）
4. 删除新创建的文件
5. 验证恢复完整性
```

### Git 集成

如果项目是 Git 仓库：
```bash
# 回滚未提交的变更
git checkout -- <modified_files>

# 删除新文件
git clean -fd <new_files_directories>
```

### 非 Git 项目

1. 在任务开始时备份将修改的文件
2. 回滚时从备份恢复
3. 删除新创建的文件

---

## 配置选项

在 `.skillpackrc` 中配置：

```json
{
  "recovery": {
    "auto_retry": true,
    "max_auto_retries": 3,
    "auto_fix_syntax": true,
    "log_level": "INFO",
    "backup_before_modify": true
  }
}
```

| 选项 | 默认值 | 说明 |
|------|--------|------|
| `auto_retry` | true | 启用自动重试 |
| `max_auto_retries` | 3 | 最大自动重试次数 |
| `auto_fix_syntax` | true | 自动修复语法错误 |
| `log_level` | INFO | 日志级别 |
| `backup_before_modify` | true | 修改前备份文件 |
