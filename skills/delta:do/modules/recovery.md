# 错误恢复模块 (Error Recovery Module) v2.0

## 概述

智能错误诊断和恢复系统，支持自动修复常见问题，提供多种恢复策略选项。v2.0 新增 **MCP 错误分类**和**指数退避重试**。

---

## 错误分类

### Level 1: 可自动恢复 (Transient)

| 错误类型 | 症状 | 自动恢复策略 |
|----------|------|--------------|
| 网络超时 | API 调用超时 | 指数退避重试，最多 3 次 |
| 临时文件锁 | 文件正在使用 | 等待 2 秒重试，最多 5 次 |
| 语法错误 (简单) | 缺少分号/括号 | 自动检测并修复 |
| 格式错误 | JSON/YAML 格式问题 | 尝试自动格式化 |
| MCP 临时不可用 | 服务暂时无响应 | 指数退避重试 |
| 速率限制 | Rate limit exceeded | 等待 Retry-After 后重试 |

### Level 2: 需用户确认 (Recoverable)

| 错误类型 | 症状 | 需确认内容 |
|----------|------|------------|
| 文件权限 | 无法读写文件 | 是否修改权限 |
| 依赖缺失 | 模块未找到 | 是否安装依赖 |
| 测试失败 | 测试未通过 | 是否继续或修复 |
| 冲突检测 | Git 冲突 | 如何解决冲突 |
| MCP 认证过期 | Auth expired | 是否刷新认证 |
| MCP 配额超限 | Quota exceeded | 是否等待或升级 |
| 模型过载 | Model overloaded | 是否选择备选模型 |

### Level 3: 需用户介入 (Fatal)

| 错误类型 | 症状 | 必需操作 |
|----------|------|----------|
| 认证失败 | API 密钥无效 | 用户提供凭证 |
| 业务逻辑 | 需求不明确 | 用户澄清需求 |
| 系统级 | 磁盘满/内存不足 | 用户处理系统问题 |
| MCP 请求无效 | Invalid request | 检查任务描述 |
| 内容过滤 | Content filtered | 修改任务内容 |
| 未知错误 | Unknown error | 查看完整错误日志 |

---

## MCP 错误处理 (v2.0 新增)

### MCP 错误代码映射

| 错误码 | 类型 | 级别 | 处理策略 |
|--------|------|------|----------|
| `ETIMEDOUT` | 网络超时 | L1 | 指数退避重试 |
| `ECONNREFUSED` | 连接拒绝 | L1 | 延迟重试 |
| `429` | 速率限制 | L1 | 等待 Retry-After |
| `401` | 认证失败 | L2 | 提示刷新认证 |
| `403` | 权限不足 | L3 | 用户检查权限 |
| `400` | 请求无效 | L3 | 检查任务描述 |
| `500` | 服务器错误 | L1 | 延迟重试 |
| `503` | 服务不可用 | L1 | 延迟重试 |

### MCP 调用失败处理流程

```
MCP 调用失败
    │
    ▼
┌─────────────────────────────────────────────┐
│ Step 1: 错误分类                             │
│   解析错误码和消息                           │
│   映射到 L1/L2/L3 级别                       │
└─────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────┐
│ Step 2: 根据级别处理                         │
│   L1 → 自动重试                             │
│   L2 → 询问用户                             │
│   L3 → 报告错误                             │
└─────────────────────────────────────────────┘
    │
    ├── L1: 自动重试
    │       │
    │       ▼
    │   重试次数 < 最大次数?
    │       ├── 是 → 等待退避时间 → 重试
    │       └── 否 → 升级为 L2
    │
    ├── L2: 询问用户
    │       │
    │       ▼
    │   ════════════════════════════════════════
    │   ⚠️ MCP 调用失败
    │   ════════════════════════════════════════
    │   工具: {tool_name}
    │   错误: {error_message}
    │   重试: {retry_count}/{max_retries}
    │   ────────────────────────────────────────
    │   📋 选项:
    │     [1] 🔄 重试
    │     [2] ⬇️ 降级到 Claude
    │     [3] ⏭️ 跳过此阶段
    │     [4] ⛔ 中止任务
    │   ════════════════════════════════════════
    │
    └── L3: 报告错误
            │
            ▼
        显示完整错误信息
        建议用户操作
```

---

## 错误诊断流程

### Step 1: 捕获错误

```
1. 记录错误发生位置（阶段、子任务、步骤）
2. 记录错误消息和堆栈
3. 记录当前环境状态
4. 保存错误前检查点
```

### Step 2: 分析错误

```
1. 解析错误类型
2. 匹配已知错误模式
3. 评估影响范围
4. 确定恢复难度
```

### Step 3: 输出诊断

```
════════════════════════════════════════════════════════════
⚠️ 执行错误
════════════════════════════════════════════════════════════
阶段: Phase {N} - {阶段名称}
位置: {具体位置描述}
────────────────────────────────────────────────────────────
错误类型: {错误分类}
错误代码: {错误码}（如有）
错误消息: {错误信息}
────────────────────────────────────────────────────────────
📊 影响分析:
  已完成: {已完成步骤}
  受影响: {受影响的文件/功能}
  可恢复: {是/否}
────────────────────────────────────────────────────────────
💡 诊断建议:
  {具体的诊断结论和建议}
────────────────────────────────────────────────────────────
```

---

## 恢复选项

### 标准恢复菜单

```
📋 恢复选项:

  [1] 🔄 继续 - 从失败点继续执行
      └── 跳过失败操作，继续下一步

  [2] 🔁 重试 - 重新执行当前步骤
      └── 使用相同参数重试当前操作

  [3] ⏪ 回滚 - 撤销本次所有变更
      └── 恢复到任务开始前的状态

  [4] ⏭️ 跳过 - 跳过当前阶段
      └── 标记当前阶段为跳过，继续下一阶段

  [5] ⛔ 中止 - 终止执行
      └── 保留已完成的工作，停止执行

请选择 (1-5):
```

### 选项详情

#### [1] 继续

- 保存错误日志
- 标记当前步骤为"跳过"
- 从下一步继续执行
- **适用**: 非关键步骤失败

#### [2] 重试

- 清除错误状态
- 重新执行当前步骤
- 最多重试 2 次（自动重试不计入）
- **适用**: 临时性错误

#### [3] 回滚

- 读取检查点备份
- 撤销所有文件变更
- 恢复到任务开始状态
- **适用**: 发现重大问题

#### [4] 跳过

- 标记当前阶段为"跳过"
- 记录跳过原因
- 进入下一阶段
- **适用**: 当前阶段可延后处理

#### [5] 中止

- 保存当前检查点
- 记录中止原因
- 输出完成摘要
- **适用**: 需要用户介入

---

## 自动恢复策略

### 指数退避重试配置 (v2.0)

```yaml
retry_policy:
  # 默认配置
  max_attempts: 3
  backoff:
    initial_delay_ms: 1000    # 首次重试延迟 1 秒
    multiplier: 2             # 每次延迟翻倍
    max_delay_ms: 30000       # 最大延迟 30 秒
    jitter: true              # 添加随机抖动

  # 按错误类型配置
  per_error_type:
    NETWORK_TIMEOUT:
      max_attempts: 5
      timeout_extension_percent: 50   # 超时后延长 50%

    RATE_LIMIT:
      use_retry_after: true           # 使用服务器返回的 Retry-After
      fallback_delay_ms: 60000        # 无 Retry-After 时默认 60 秒

    MODEL_OVERLOADED:
      max_attempts: 2
      suggest_fallback_model: true    # 建议使用备选模型

    MCP_ABORT:
      max_attempts: 1                 # 用户中断不重试
      prompt_user: true               # 直接询问用户
```

### 重试序列示例

```
尝试 1: 立即执行
失败 → 等待 1s (+ jitter)
尝试 2: 执行
失败 → 等待 2s (+ jitter)
尝试 3: 执行
失败 → 等待 4s (+ jitter)
尝试 4: 执行
失败 → 升级为 L2，询问用户
```

### 网络错误

```python
retry_config = {
    "max_retries": 3,
    "base_delay": 5,  # 秒
    "backoff": 2,     # 指数退避
    "max_delay": 30
}

# 重试序列: 5s, 10s, 20s
```

### 语法错误自动修复

**支持的修复**:
- 缺少分号 → 自动添加
- 缺少闭合括号 → 自动添加
- 缩进错误 → 自动修正
- 尾随逗号 → 自动处理

**修复流程**:
```
1. 解析错误信息定位问题
2. 应用修复
3. 重新验证
4. 如修复失败，回退并报告
```

### 文件锁等待

```
max_wait: 10 秒
check_interval: 2 秒
retry_count: 5 次
```

---

## 智能诊断建议

### 错误模式匹配

| 错误模式 | 诊断 | 建议 |
|----------|------|------|
| `ENOENT` | 文件不存在 | 检查路径，或创建文件 |
| `EACCES` | 权限不足 | 检查文件权限 |
| `ENOSPC` | 磁盘空间不足 | 清理磁盘空间 |
| `MODULE_NOT_FOUND` | 依赖缺失 | 运行 npm install |
| `SyntaxError` | 语法错误 | 检查代码语法 |
| `TypeError` | 类型错误 | 检查变量类型 |
| `ETIMEDOUT` | 网络超时 | 检查网络连接 |
| `401/403` | 认证/授权失败 | 检查凭证 |

### 上下文感知建议

基于当前执行阶段提供针对性建议：

**Phase 1 (分析/规划)**:
- 建议重新分析任务描述
- 检查项目结构是否正确

**Phase 2 (实现)**:
- 检查依赖是否安装
- 验证 API 接口是否可用

**Phase 3 (审查)**:
- 运行测试确认功能
- 检查代码风格

---

## 错误日志

### 日志格式

位置: `.skillpack/current/error.log`

```
================================================================================
[2024-01-18T10:30:45.123Z] ERROR
================================================================================
Phase: 2 - 实现
Step: 3 - 创建认证模块
File: src/auth.ts

Type: SyntaxError
Message: Unexpected token '}'
Stack:
  at Parser.parse (parser.js:123)
  at compile (compiler.js:45)

Context:
  Line: 42
  Code: if (user.isValid) {

Recovery:
  Attempt: auto-fix
  Result: success
  Action: Added missing closing brace at line 58

================================================================================
```

### 日志级别

| 级别 | 说明 | 记录内容 |
|------|------|----------|
| ERROR | 执行错误 | 完整错误信息 + 上下文 |
| WARN | 警告 | 潜在问题 |
| INFO | 信息 | 恢复操作记录 |
| DEBUG | 调试 | 详细执行步骤（可选） |

---

## 回滚机制

### 文件级回滚

```
1. 读取检查点中的文件校验和
2. 比对当前文件
3. 恢复修改的文件（从 Git 或备份）
4. 删除新创建的文件
5. 验证恢复完整性
```

### Git 集成

如果项目是 Git 仓库：
```bash
# 回滚未提交的变更
git checkout -- <modified_files>

# 删除新文件
git clean -fd <new_files_directories>
```

### 非 Git 项目

1. 在任务开始时备份将修改的文件
2. 回滚时从备份恢复
3. 删除新创建的文件

---

## 配置选项

在 `.skillpackrc` 中配置：

```json
{
  "recovery": {
    "auto_retry": true,
    "max_auto_retries": 3,
    "auto_fix_syntax": true,
    "log_level": "INFO",
    "backup_before_modify": true
  }
}
```

| 选项 | 默认值 | 说明 |
|------|--------|------|
| `auto_retry` | true | 启用自动重试 |
| `max_auto_retries` | 3 | 最大自动重试次数 |
| `auto_fix_syntax` | true | 自动修复语法错误 |
| `log_level` | INFO | 日志级别 |
| `backup_before_modify` | true | 修改前备份文件 |
