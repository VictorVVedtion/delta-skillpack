# /do Skill - 执行指令

当用户调用 `/do <任务>` 时，按以下流程执行：

## 核心原则

1. **立即行动** - 不要只是解释，要真正执行任务
2. **使用工具** - 充分利用 Claude Code 的所有工具（Glob, Grep, Read, Edit, Write, Bash, Task 等）
3. **持续追踪** - 使用 TodoWrite 追踪复杂任务的进度
4. **实时反馈** - 每个关键步骤都输出进度提示
5. **错误恢复** - 遇到错误时提供恢复选项

## 复杂度判断规则

### 简单任务 → DIRECT (直接执行)
匹配以下任一条件:
- 包含: `typo`, `拼写`, `comment`, `注释`, `rename`, `重命名`
- 描述少于 8 个词
- 明确指向单个文件

### UI 任务 → UI_FLOW
匹配以下任一条件:
- 包含: `ui`, `ux`, `界面`, `组件`, `component`, `页面`, `page`, `布局`, `layout`, `样式`, `style`, `css`, `tailwind`, `前端`, `frontend`, `按钮`, `button`, `表单`, `form`

### 复杂任务 → RALPH (Ralph 自动化)
匹配以下任一条件:
- 包含: `system`, `系统`, `架构`, `architecture`, `完整`, `complete`, `comprehensive`, `从零`, `from scratch`, `多模块`, `multi-module`
- 包含: `fork`, `clone`, `构建`, `build` + 项目名
- 描述超过 30 个词

### 中等任务 → PLANNED (规划执行)
不匹配以上任何类别的任务

## 阶段提示格式

**每个阶段开始时必须输出**：

```
════════════════════════════════════════════════════════════
📍 Phase {N}/{TOTAL}: {阶段名称} ({Phase Name})
════════════════════════════════════════════════════════════
进度: {进度条} {百分比}%
上一阶段: {状态} {结果}
当前任务: {目标}
输出文件: {路径}
────────────────────────────────────────────────────────────
```

## 执行流程

### 简单任务 (DIRECT)

```
1. 直接使用工具执行
2. 输出简短完成摘要
```

### 中等任务 (PLANNED)

```
Phase 1 (30%): 规划阶段
  - 分析需求
  - 列出实施步骤（3-7步）
  - 创建 TodoWrite 列表

Phase 2 (60%): 实现阶段
  - 逐步执行计划
  - 每步完成后更新 Todo 状态

Phase 3 (100%): 审查阶段
  - 检查代码质量
  - 输出完成摘要
```

### 复杂任务 (RALPH)

```
Phase 1 (20%): 分析阶段
  - 将大任务拆分为子任务
  - 识别依赖关系

Phase 2 (40%): 规划阶段
  - 为每个子任务生成实施步骤
  - 创建详细 TodoWrite 列表

Phase 3 (75%): 执行阶段
  - 按依赖顺序执行子任务
  - 必要时使用 Task agent 并行处理

Phase 4 (100%): 审查阶段
  - 验证所有子任务完成
  - 输出完成报告
```

### UI 任务 (UI_FLOW)

```
Phase 1 (30%): UI 设计
  - 分析 UI 需求
  - 确定组件结构

Phase 2 (60%): 实现
  - 创建/修改组件文件
  - 添加样式

Phase 3 (100%): 预览
  - 使用 mcp__claude-in-chrome__* 工具预览（如可用）
  - 截图展示结果
```

## 错误处理

当阶段执行失败时：

### Step 1: 保存状态
将已完成的工作保存到 `.skillpack/current/`

### Step 2: 诊断输出
```
════════════════════════════════════════════════════════════
⚠️ 阶段执行失败
════════════════════════════════════════════════════════════
失败阶段: Phase {N} - {阶段名称}
错误类型: {错误类别}
错误详情: {具体错误信息}
────────────────────────────────────────────────────────────
```

### Step 3: 恢复选项
```
📋 恢复选项:
  [1] 继续 - 从失败点继续
  [2] 重试 - 重新执行当前阶段
  [3] 回滚 - 撤销本次变更
  [4] 跳过 - 跳过当前阶段
  [5] 中止 - 终止执行
```

### 自动恢复
- 网络超时: 等待 5 秒后自动重试 (最多 3 次)
- 语法错误: 自动分析并尝试修复 (最多 2 次)

## 知识库集成

如果项目根目录存在 `.skillpackrc` 文件:
1. 读取配置获取 `knowledge.default_notebook`
2. 使用 `mcp__notebooklm-mcp__notebook_query` 查询相关文档
3. 将知识注入执行上下文

## 输出格式

任务完成时输出:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 任务完成

📋 任务: <任务描述>
📊 复杂度: <简单|中等|复杂|UI>
🚀 执行路径: <对应路径>

📁 变更文件:
  - path/to/file1.ts (新增/修改/删除)
  - path/to/file2.ts

📝 摘要:
  <2-3句话总结完成的工作>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 输出管理

- **当前执行**: `.skillpack/current/`
- **历史记录**: `.skillpack/history/<timestamp>/`
- **错误日志**: `.skillpack/current/error.log`
