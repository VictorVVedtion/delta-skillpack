---
name: delta:do
description: 统一任务入口 - 智能分析任务复杂度，自动路由到最优执行路径，错误恢复
version: 2.1.0
---

# delta:do - 智能任务执行器

## 调用方式

```
/do <任务描述>
/do <任务描述> --quick    # 跳过规划，直接执行
/do <任务描述> --deep     # 强制 Ralph 自动化模式
/do <任务描述> --explain  # 仅显示路由决策，不执行
```

## 示例

```
/do fix typo in README
/do add user authentication with JWT
/do 完整 fork hyperliquid SDK
/do 创建登录页面组件
```

---

## 执行流程

当此 skill 被调用时，按以下步骤执行：

### Step 1: 任务复杂度分析

分析任务描述，判断复杂度等级：

**简单任务信号** → DIRECT 路由:
- 包含: typo, 拼写, comment, 注释, rename, 重命名
- 描述少于 10 个词
- 单文件修改

**中等任务信号** → PLANNED 路由:
- 新功能开发
- Bug 修复
- 小型重构
- 2-5 个文件修改

**复杂任务信号** → RALPH 路由:
- 包含: system, 系统, 架构, architecture, 完整, complete, 从零, from scratch
- 多模块变更
- 系统级重构

**UI 任务信号** → UI_FLOW 路由:
- 包含: ui, ux, 界面, 组件, component, 页面, page, 布局, layout, 样式, css, 前端, frontend

### Step 2: 执行路由

| 复杂度 | 执行路径 | 阶段 |
|--------|----------|------|
| 简单 | 直接执行 | 1 |
| 中等 | 规划 → 实现 → 审查 | 3 |
| 复杂 | 分析 → 规划 → 逐个执行 → 综合审查 | 4 |
| UI | UI设计 → 实现 → 预览 | 3 |

### Step 3: 知识库集成

如果项目配置了 `.skillpackrc`，自动查询 NotebookLM 获取：
- 项目架构文档
- 代码规范
- 相关 API 文档

---

## 执行策略

### DIRECT（直接执行）

**如果是简单任务:**
1. 使用 Glob/Grep 找到相关文件
2. 使用 Read 读取内容
3. 使用 Edit 进行修改
4. 输出完成摘要

### PLANNED（计划执行）

**如果是中等任务:**
1. **Phase 1 - 规划**: 创建实施计划 (列出步骤)
2. **Phase 2 - 实现**: 逐步执行计划，每步完成后更新进度
3. **Phase 3 - 审查**: 代码审查，检查质量

### RALPH（复杂任务自动化）

**如果是复杂任务:**
1. **Phase 1 - 分析**: 创建详细的任务分解
2. **Phase 2 - 规划**: 为每个子任务生成实施步骤
3. **Phase 3 - 执行**: 按依赖顺序执行子任务
4. **Phase 4 - 审查**: 综合审查所有变更

### UI_FLOW（UI 流程）

**如果是 UI 任务:**
1. **Phase 1 - 设计**: 分析 UI 需求，设计组件结构
2. **Phase 2 - 实现**: 实现代码
3. **Phase 3 - 预览**: 如可能，使用浏览器工具预览

---

## 阶段转换提示

**每个阶段开始时，输出清晰的进度提示**：

```
════════════════════════════════════════════════════════════
📍 Phase {N}/{TOTAL}: {阶段名称} ({Phase Name})
════════════════════════════════════════════════════════════
进度: {进度条} {百分比}%
上一阶段: {状态图标} {上一阶段结果}
当前任务: {当前阶段的目标}
输出文件: {对应的输出文件路径}
────────────────────────────────────────────────────────────
```

### 进度条计算

| 路由 | Phase 1 | Phase 2 | Phase 3 | Phase 4 |
|------|---------|---------|---------|---------|
| DIRECT | 100% | - | - | - |
| PLANNED | 30% | 60% | 100% | - |
| RALPH | 20% | 40% | 75% | 100% |
| UI_FLOW | 30% | 60% | 100% | - |

---

## 错误处理

### 阶段失败恢复

当任一阶段执行失败时：

#### Step 1: 保存当前状态
将已完成的工作保存到 `.skillpack/current/`

#### Step 2: 诊断问题
```
════════════════════════════════════════════════════════════
⚠️ 阶段执行失败
════════════════════════════════════════════════════════════
失败阶段: Phase {N} - {阶段名称}
错误类型: {错误类别}
错误详情: {具体错误信息}
────────────────────────────────────────────────────────────
```

#### Step 3: 提供恢复选项
```
📋 恢复选项:
  [1] 继续 - 从失败点继续执行
  [2] 重试 - 重新执行当前阶段
  [3] 回滚 - 撤销本次所有变更
  [4] 跳过 - 跳过当前阶段，继续下一阶段
  [5] 中止 - 终止执行，保留已完成部分
```

### 常见错误处理策略

| 错误类型 | 默认恢复策略 |
|----------|--------------|
| 文件权限 | 提示用户修改权限 |
| 语法错误 | 自动尝试修复 (最多 2 次) |
| 测试失败 | 显示失败详情，建议修复 |
| 依赖缺失 | 提示安装依赖 |
| 网络错误 | 等待重试 (最多 3 次) |

---

## 输出结果

任务完成后输出：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 任务完成

📋 任务: {{TASK}}
📊 复杂度: {{COMPLEXITY}}
🚀 执行路径: {{ROUTE}}

📁 变更文件:
  - file1.ts (新增)
  - file2.ts (修改)

📝 摘要:
  {{SUMMARY}}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 输出管理

- **当前执行**: `.skillpack/current/`
- **历史记录**: `.skillpack/history/<timestamp>/`
- **错误日志**: `.skillpack/current/error.log`

| 路由 | 输出文件 |
|------|----------|
| DIRECT | `output.txt` |
| PLANNED | `1_plan.md`, `2_implementation.md`, `3_review.md` |
| RALPH | `1_analysis.md`, `2_plan.md`, `3_subtask_*.md`, `4_review.md` |
| UI_FLOW | `1_ui_design.md`, `2_implementation.md`, `3_preview.md` |

---

## 与其他 Skills 的关系

`/do` 是统一入口，内部会调用：
- 简单任务: 直接 Claude Code 操作
- 中等任务: 类似 `delta:plan` + `delta:implement` + `delta:review`
- 复杂任务: 类似 `delta:ralph-start`
- UI 任务: 类似 `delta:ui` + `delta:implement`
