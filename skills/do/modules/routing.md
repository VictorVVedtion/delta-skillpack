# 路由决策矩阵 (Routing Decision Matrix)

## 概述

基于加权评分系统的结果，通过决策矩阵确定最优执行路由。支持 5 种核心路由和强制模式覆盖。

---

## 路由类型

| 路由 | 复杂度分数 | 阶段数 | 核心原则 | 适用场景 |
|------|-----------|--------|----------|----------|
| **DIRECT_TEXT** | 0-20 (文本) | 1 | 立即行动 | 文档、注释、配置 |
| **DIRECT_CODE** | 0-20 (代码) | 1 | 立即行动 | 简单代码修复 |
| **PLANNED** | 21-45 | 3 | 计划先行 | 新功能、常规开发 |
| **RALPH** | 46-70 | 5 | 分而治之 | 多模块、系统功能 |
| **ARCHITECT** | 71-100 | 6 | 架构优先 | 系统设计、重大重构 |
| **UI_FLOW** | UI 信号 | 3 | 用户至上 | UI/UX 相关任务 |

---

## 决策流程

```
┌─────────────────────────────────────────────────────────┐
│                    任务输入                              │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│              检查强制模式参数                            │
│  --quick → DIRECT    --deep → RALPH                     │
└──────────────────────┬──────────────────────────────────┘
                       │ 无强制模式
                       ▼
┌─────────────────────────────────────────────────────────┐
│              执行加权评分                                │
│  → 调用 modules/scoring.md 计算总分                     │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│              检查 UI 信号                                │
│  UI 复杂度 >= 5 且包含 UI 关键词 → UI_FLOW              │
└──────────────────────┬──────────────────────────────────┘
                       │ 非 UI 任务
                       ▼
┌─────────────────────────────────────────────────────────┐
│              根据总分决定路由                            │
│  0-20: DIRECT | 21-45: PLANNED                         │
│  46-70: RALPH | 71-100: ARCHITECT                      │
└─────────────────────────────────────────────────────────┘
```

---

## 路由详情

### DIRECT_TEXT (文本直接执行) - Claude

**复杂度**: 0-20 分 (文本任务)
**阶段**: 1 个

```
Phase 1: 执行 (100%)
  └── Claude 直接完成任务，输出简短摘要
```

**特征**:
- 无需规划，立即行动
- 适合文档、注释、配置修改

**输出文件**: `.skillpack/current/output.txt`

---

### DIRECT_CODE (代码直接执行) - Codex

**复杂度**: 0-20 分 (代码任务)
**阶段**: 1 个

```
Phase 1: 执行 (100%)
  └── Codex (CLI) 直接完成代码任务
```

**特征**:
- 无需规划，立即行动
- 适合简单代码修复、函数添加

**输出文件**: `.skillpack/current/output.txt`

---

### PLANNED (计划执行)

**复杂度**: 21-45 分
**阶段**: 3 个

```
Phase 1: 规划 (30%)
  ├── 分析需求
  ├── 列出实施步骤
  └── 识别关键文件

Phase 2: 实现 (60%)
  ├── 逐步执行计划
  └── 更新 Todo 状态

Phase 3: 审查 (100%)
  ├── 代码质量检查
  └── 输出完成摘要
```

**输出文件**:
- `.skillpack/current/1_plan.md`
- `.skillpack/current/2_implementation.md`
- `.skillpack/current/3_review.md`

---

### RALPH (复杂任务自动化) - Claude + Codex + Gemini

**复杂度**: 46-70 分
**阶段**: 5 个

```
Phase 1: 深度分析 (20%)
  ├── 任务分解 - Claude
  ├── 依赖关系识别
  └── 风险评估

Phase 2: 规划 (35%)
  ├── 子任务详细规划 - Claude
  └── 执行顺序确定

Phase 3: 执行 (60%)
  ├── 按依赖顺序执行 - Codex (CLI)
  ├── 支持并行子任务
  └── 保存检查点

Phase 4: 独立审查 (85%)
  ├── 跨模型审查 - Gemini (CLI)
  └── 需求覆盖验证

Phase 5: 仲裁验证 (100%)
  ├── 分歧处理 - Claude
  └── 最终确认
```

**输出文件**:
- `.skillpack/current/1_analysis.md`
- `.skillpack/current/2_plan.md`
- `.skillpack/current/3_subtask_*.md`
- `.skillpack/current/4_review.md`
- `.skillpack/current/5_arbitration.md`

---

### ARCHITECT (架构优先) - Gemini + Claude + Codex

**复杂度**: 71-100 分
**阶段**: 6 个

```
Phase 1: 架构分析 (15%)
  ├── 系统全局分析 - Gemini (CLI)
  ├── 现有架构评估
  └── 约束条件识别

Phase 2: 架构设计 (25%)
  ├── 目标架构设计 - Claude
  ├── 技术选型
  └── 接口定义

Phase 3: 实施规划 (40%)
  ├── 详细任务分解 - Claude
  ├── 迁移策略
  └── 回滚方案

Phase 4: 分阶段实施 (65%)
  ├── 按阶段执行 - Codex (CLI)
  ├── 支持并行执行
  └── 检查点保存

Phase 5: 独立审查 (85%)
  ├── 跨模型审查 - Gemini (CLI)
  └── 架构一致性验证

Phase 6: 仲裁验证 (100%)
  ├── 分歧处理 - Claude
  └── 最终确认
```

**输出文件**:
- `.skillpack/current/1_architecture_analysis.md`
- `.skillpack/current/2_architecture_design.md`
- `.skillpack/current/3_implementation_plan.md`
- `.skillpack/current/4_phase_*.md`
- `.skillpack/current/5_review.md`
- `.skillpack/current/6_arbitration.md`

---

### UI_FLOW (UI 流程)

**触发条件**: UI 复杂度 >= 5 且包含 UI 关键词
**阶段**: 3 个

```
Phase 1: UI 设计 (30%)
  ├── 组件结构设计
  ├── 样式规范
  └── 交互设计

Phase 2: 实现 (60%)
  ├── 组件开发
  ├── 样式实现
  └── 响应式适配

Phase 3: 预览 (100%)
  ├── 视觉验证
  └── 交互测试
```

**输出文件**:
- `.skillpack/current/1_ui_design.md`
- `.skillpack/current/2_implementation.md`
- `.skillpack/current/3_preview.md`

---

## 强制模式

### --quick (-q)

强制使用 DIRECT 路由，跳过所有规划阶段。

```bash
/do "add feature X" --quick
```

**适用场景**:
- 用户确定任务简单
- 紧急修复
- 已有明确实施方案

### --deep (-d)

强制使用 RALPH 路由，进行深度分析。

```bash
/do "add feature X" --deep
```

**适用场景**:
- 用户希望更谨慎处理
- 任务看似简单但影响广泛
- 学习/探索目的

### --explain (-e)

仅输出路由决策，不执行任务。

```bash
/do "add feature X" --explain
```

**输出格式**:
```
════════════════════════════════════════════════════════════
📊 任务复杂度分析
════════════════════════════════════════════════════════════
复杂度评分: {总分}/100

┌────────────────────────────────────────┐
│ 范围广度:    {条形图} {scope}/25       │
│ 依赖复杂度:  {条形图} {dependency}/20  │
│ 技术深度:    {条形图} {technical}/20   │
│ 风险等级:    {条形图} {risk}/15        │
│ 时间估算:    {条形图} {time}/10        │
│ UI 复杂度:   {条形图} {ui}/10          │
└────────────────────────────────────────┘

🚀 推荐路由: {路由名称}
📝 路由原因: {原因说明}
────────────────────────────────────────────────────────────
```

---

## 路由决策输出

每次路由决策后，输出以下信息：

```
════════════════════════════════════════════════════════════
📍 路由决策: {路由名称} | 复杂度: {总分}/100
════════════════════════════════════════════════════════════
核心原则: {原则}
执行阶段: {阶段数} 个阶段
预计工作量: {时间估算}
────────────────────────────────────────────────────────────
```

---

## 边界情况处理

### 分数边界 (±2 分)

当分数接近路由边界时（如 19-22, 44-47, 69-72），输出提示：

```
⚠️ 复杂度分数 {score} 接近路由边界
当前路由: {current_route}
如需切换，可使用 --quick 或 --deep 参数
```

### UI 信号优先级

当同时满足 UI 信号和高复杂度分数时：
- 如果 UI 复杂度 >= 7，优先使用 UI_FLOW
- 如果总分 >= 70 且 UI 复杂度 < 7，使用 ARCHITECT/RALPH

### 混合任务

对于同时包含后端和前端的任务：
1. 评估主要工作量在哪一侧
2. 如果前端 > 60%，使用 UI_FLOW
3. 否则按分数选择路由，在实施阶段内嵌 UI 子流程
